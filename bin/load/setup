#!/usr/bin/env bash

pushd `pwd` # store current dir
cd `dirname "$0"` # cd to script path
cd ../.. # cd to project root

echo "--- SETUP: setting up service databases..."
docker-compose -f docker-compose-test-load.yml up -d db 2>/dev/null 1>&2

sleep 2

### MIGRATIONS

#### signalboost
docker-compose -f docker-compose-test-load.yml run --entrypoint /signalboost/bin/db/setup app


#### signalc
psql -q postgresql://postgres@localhost:5432 -U postgres -c "create database signalc_load_test_simulator;"
docker-compose -f docker-compose-test-load.yml run \
  -e SIGNALC_DB_NAME=signalc_load_test_simulator -e SIGNALC_ENV=load \
  --entrypoint 'gradle --console=plain update' signalc_simulator

docker-compose -f docker-compose-test-load.yml down

popd